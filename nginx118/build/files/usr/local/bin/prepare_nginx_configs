#!/bin/bash
set -e

CONFIGS="$(find /etc/nginx/ -type f)"
ENV_VARS="$(env | cut -d= -f1 | grep -v '^.$')"

for FILE_NAME in $CONFIGS; do
  for VAR_NAME in $ENV_VARS; do
    VAR_VALUE=$(printenv "$VAR_NAME")
    if [[ -n "$VAR_VALUE" ]]; then
      ESCAPED_VAR_VALUE=$(printf '%s' "$VAR_VALUE" | sed -e 's/[\/&]/\\&/g' -e "s/'/'\\\\''/g")
      PATTERN="s|\\{$VAR_NAME\\}|$ESCAPED_VAR_VALUE|g"
      sed -ri "$PATTERN" "$FILE_NAME" 2>/dev/null || true
    fi
  done
done

if [[ "$NFQ_FASTCGI_HOST" == 'false' || -z "$NFQ_FASTCGI_HOST" ]]; then
  cp -f /etc/nginx/conf.d/default_wo_fastcgi /etc/nginx/sites-available/default
fi
